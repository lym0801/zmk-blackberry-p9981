name: Build ZMK Firmware for BlackBerry P9981

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 步骤1：安装系统依赖
      - name: Install System Dependencies
        run: |
          sudo apt update -y
          sudo apt install -y git ninja-build gperf ccache dfu-util device-tree-compiler wget
          sudo apt install -y python3 python3-pip python3-venv python3-dev libffi-dev libssl-dev
          python3 --version
          pip3 --version

      # 步骤2：安装 west 1.0.0（严格匹配，无版本偏差）
      - name: Install ZMK West Tool (v1.0.0)
        run: |
          pip3 install --upgrade pip
          pip3 install --user west==1.0.0
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          west --version  # 验证版本：必须输出 1.0.0

      # 步骤3：拉取 ZMK v0.3.0 源码
      - name: Checkout ZMK Source Code
        uses: actions/checkout@v4
        with:
          repository: zmkfirmware/zmk
          ref: v0.3.0
          path: zmk
          submodules: recursive

      # 步骤4：拉取用户配置
      - name: Checkout User Config
        uses: actions/checkout@v4
        with:
          path: zmk/config

      # 步骤5：West 初始化（纯原生命令，无多余参数）
      - name: West Init (Pure v1.0.0)
        run: |
          cd zmk
          # west 1.0.0 原生初始化命令
          west init -l app/
          # 清理 manifest 缓存，避免导入报错
          rm -rf .west/manifest-cache || true

      # 步骤6：West Update（仅保留 v1.0.0 支持的参数）
      - name: West Update Dependencies (v1.0.0 Native)
        run: |
          cd zmk
          # 仅用 west 1.0.0 支持的参数：-n=--narrow（浅克隆）、-o=--fetch-opt（拉取参数）
          # 重试逻辑：失败后重新执行，替代 --timeout
          west update -n -o "--depth=1" || west update -n -o "--depth=1"

      # 步骤7：West Zephyr Export（原生命令）
      - name: West Zephyr Export
        run: |
          cd zmk
          west zephyr-export

      # 步骤8：编译固件（纯原生命令）
      - name: Build Nice!Nano v2 Firmware
        run: |
          cd zmk
          west build -s app -b nice_nano_v2 -- -DZMK_CONFIG=config

      # 步骤9：上传 UF2 固件
      - name: Upload UF2 Artifact
        uses: actions/upload-artifact@v4
        with:
          name: blackberry-p9981-uf2-firmware
          path: zmk/build/zephyr/zmk.uf2

      # 可选：发布固件
      - name: Release Firmware
        uses: softprops/action-gh-release@v2
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        with:
          files: zmk/build/zephyr/zmk.uf2
          tag_name: v${{ github.run_number }}
          name: BlackBerry P9981 Firmware v${{ github.run_number }}
          body: Auto-built ZMK UF2 firmware for Nice!Nano v2 (west 1.0.0 pure)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
